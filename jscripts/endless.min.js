/**
 * Endless beta 1 Â© Shade 2012-2018
 *
 * Thanks to https://github.com/flarum/core for inspiration, both on visual and code side
 **/
!function(){$.fn.afterTransition=function(e){return this.each(function(){$(this).bind("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd transitionend webkitTransitionEAnind oTransitionEnd MSTransitionEnd",function(){"function"==typeof e&&e.call(this)})})};var e=$(document);Endless={visibleItems:{},itemsCache:[],itemsInDOM:[],range:{},safeMargin:300,loadIds:[],mode:"",pagesLoading:0,loadPageTimeouts:{},class:{scrolledItem:"endless-new-item",placeholder:"endless-placeholder"},timeouts:{},init:function(s){if(Endless.options=$.extend({cid:0,lastNode:0,custom:!1,automaticDetection:!0,enableScrubber:!1,itemsLoadedPerPage:10,itemsShownPerPage:10,page:1},s),!Endless.options.cid||!Endless.options.lastNode)return!1;$(window).on("unload",function(){$(window).scrollTop(0)}),window.onunload=function(){window.scrollTo(0,0)},"scrollRestoration"in history&&(history.scrollRestoration="manual"),Endless.paused=!1,Endless.mode=$(".post").length?"posts":"threads",Endless.itemsCache.length=0,Endless.itemsInDOM.length=0,Endless.visibleItems={},Endless.scrollListener.active=!1;var n="posts"==Endless.mode?$(".post"):$(".thread");Endless.options.page--;var t=1;n.each(function(){var e=$(this),s=parseInt(Endless.options.page*Endless.options.itemsShownPerPage+t);if(!isNaN(s)){e.attr("data-node-number",s),t++;var n=e.hasClass("post")?e.attr("id").slice(5):e.find('[id*="tid_"]').attr("id").slice(4);return Endless.saveItemInCache(s,e,n)}}),Endless.cache.normalize(),Endless.itemsLoadedPerPage=Math.min(30,Endless.itemsLoadedPerPage),history.replaceState(null,"",Endless.removeUrlParameter(window.location.href,"page")),Endless.range.calculateCurrent(),Endless.calculateVisibleItems();var r=Endless.getUrlParameter("pid");if(r){var o=$("#post_"+r);o.length&&$.when(Endless.scrollHandler.toItem(o)).then(()=>{1!=Endless.range.first&&(Endless.visibleItems.first-1)%Endless.options.itemsLoadedPerPage==0&&Endless.loadPrevious()})}else 1!=Endless.range.first&&Endless.loadPrevious();if("undefined"!=typeof Thread){var a=Thread.quickReplyDone,l={};Thread.quickReplyDone=function(e,s){if($.parseJSON(e.responseText).hasOwnProperty("errors"))return!1;Endless.options.lastNode++,$(".Scrubber-count").text(Endless.options.lastNode);var n="";return l[Endless.options.lastNode]=setInterval(function(e){if(0==(n=$('[data-node-number="'+(e-1)+'"] ~ [id*="post_"]')).length)return!1;Endless.saveItemInCache(e,n.attr("data-node-number",e),n.attr("id").slice(5)),clearInterval(l[e])},200,Endless.options.lastNode),a.call(this,e,s)}}Endless.options.automaticDetection?(Endless.scrollListener.start(Endless.onScroll),Endless.options.enableScrubber&&(Endless.scrubber.show(),$(window).on("resize",Endless.scrubber.onResize.bind(this)).resize(),$(".Scrubber-scrollbar").bind("click",Endless.scrubber.onClick.bind(this)).css({cursor:"pointer","user-select":"none"}).bind("dragstart mousedown touchstart",e=>e.preventDefault()),$(".Scrubber-handle").css("cursor","move").bind("mousedown touchstart",Endless.scrubber.onMouseDown.bind(this)).click(e=>e.stopPropagation()),$(".Scrubber-first").bind("click",Endless.scrubber.goToFirst.bind(this)),$(".Scrubber-last").bind("click",Endless.scrubber.goToLast.bind(this)),$(".Dropdown-toggle").bind("click",Endless.scrubber.toggleDropdown.bind(this)),e.on("mousemove touchmove",Endless.scrubber.onMouseMove.bind(this)).on("mouseup touchend",Endless.scrubber.onMouseUp.bind(this)))):$("body").on("click",".loadNextPage, .loadPrevPage",function(){!$(this).hasClass("loadNextPage")?Endless.loadPrevious():Endless.loadNext()})},updateLocation:function(){var e,s=Endless.scrubber.index,n=Endless.range.countTotalItems(),t=Endless.scrubber.visible||1,r=1==Math.min(s,n-t)?1:Math.ceil(s+t);if(r=Endless.sanitizeIndex(r),"posts"==Endless.mode){try{var o=Endless.itemsCache[r].id}catch(e){return!1}e=Endless.replaceUrlParameter(window.location.href,"pid",o)+"#pid"+o}else{var a=Math.floor(r/Endless.options.itemsShownPerPage+1);a&&(e=Endless.replaceUrlParameter(window.location.href,"page",a))}return history.replaceState(null,"",e)},replaceUrlParameter:function(e,s,n){null==n&&(n="");var t=new RegExp("("+s+"=).*?(&|$)");return e.search(t)>=0?e.replace(t,"$1"+n+"$2"):e+(e.indexOf("?")>0?"&":"?")+s+"="+n},removeUrlParameter:function(e,s){var n=e.split("?");if(n.length>=2){for(var t=n.shift(),r=n.join("?"),o=encodeURIComponent(s)+"=",a=r.split(/[&;]/g),l=a.length;l-- >0;)-1!==a[l].lastIndexOf(o,0)&&a.splice(l,1);e=a.length?t+"?"+a.join("&"):t}return e},getUrlParameter:function(e){var s,n,t=decodeURIComponent(window.location.search.substring(1)).split("&");for(n=0;n<t.length;n++)if((s=t[n].split("="))[0]===e)return void 0===s[1]||s[1]},onScroll:function(){if(!Endless.paused){Endless.calculateVisibleItems();Endless.scrubber.renderScrollbar(!0);Endless.delayExecution("updateUrl",Endless.updateLocation),Endless.delayExecution("normalizeCache",Endless.cache.normalize,1e3);var e=Endless.scrollListener.currentTop,s=e<Endless.scrollListener.lastTop,n=$('[data-node-number="'+Endless.range.first+'"]'),t=$('[data-node-number="'+Endless.range.last+'"]'),r=$(window).height(),o={};n.length&&(o.top=n.offset().top+Endless.safeMargin),t.length&&(o.bottom=t.offset().top-r-Endless.safeMargin),(s&&e<o.top||!s&&e>o.bottom)&&(s?Endless.loadPrevious():Endless.loadNext())}},redraw:function(){Math.floor(10*Math.random()+1);var e=$.Deferred(),s=[],n=[],t=$("[data-node-number]"),r=[],o="",a=this.itemsInDOM.slice(),l=this.range.first,i=this.range.last;if("posts"==Endless.mode)o=$(Endless.templates.post);else{var d=Number($("[data-node-number]:not(."+Endless.class.placeholder+"):first > td").length);o=$(Endless.templates.thread.replace(/\{colspan\}/g,d))}for(var c=0,u=l;u<=i;u++){var b=!Endless.exists(Endless.itemsCache[u]),E=b?o.clone().attr("data-node-number",u).addClass(Endless.class.placeholder):Endless.itemsCache[u].content,m=$('[data-node-number="'+u+'"]');m.length?(-1==a.indexOf(u)&&a.push(u),m.hasClass(Endless.class.placeholder)&&!b&&(m.replaceWith(E),r.push(u))):(b||Endless.saveToCurrentListOfItems(u),s.push({content:E,id:u}),r.push(u))}return s.length&&($.each(s,function(e,s){var n=s.id,t=Endless.getClosestIdentifier(n,a),r=$('[data-node-number="'+t+'"]');r.length&&(n<t?r.before(s.content):n>t&&r.after(s.content),a.push(n))}),Endless.updateMyBBFunctions(r)),$.each(t,function(e,s){var t=parseInt($(this).attr("data-node-number"));(t<l||t>i)&&!$('[data-node-number="'+t+'"]').hasClass("protected")&&(n.push('[data-node-number="'+t+'"]'),(c=Endless.itemsInDOM.indexOf(t))>-1&&("posts"==Endless.mode&&Endless.itemsCache[t]&&n.push("#pid"+Endless.itemsCache[t].id),Endless.itemsInDOM.splice(c,1)))}),n.length&&$(n.join()).remove(),Endless.cache.normalize(),e.resolve().promise()},updateMyBBFunctions:function(e){if(!e.length)return!1;$.each(e,function(e,s){var n=Endless.itemsCache[s];if(!Endless.exists(n))return!1;if("posts"==Endless.mode)var t,r="post_"+(t=n.id);var o=$('[data-node-number="'+s+'"]');r&&o.attr("id",r),t&&"undefined"!=typeof Thread&&Thread.quickEdit("#pid_"+t)}),"undefined"!=typeof inlineModeration&&$('[data-node-number] [id*="inlinemod_"]').on("change",inlineModeration.checkItem)},saveToCurrentListOfItems:function(e){return e=parseInt(e),-1==Endless.itemsInDOM.indexOf(e)&&Endless.itemsInDOM.push(e)},saveItemInCache:function(e,s,n){if(e=parseInt(e),isNaN(e))return!1;Endless.saveToCurrentListOfItems(e);s.hasClass("post");var t=$("<div />").append(s.clone()).contents();return Endless.itemsCache[e]={content:t.removeClass(Endless.class.scrolledItem)},n&&(Endless.itemsCache[e].id=parseInt(n)),Endless.itemsCache[e]},removeFromTree:function(e){e=parseInt(e);var s=Endless.itemsInDOM.indexOf(e);return s>-1&&(Endless.itemsCache.splice(e,1),Endless.itemsInDOM.splice(s,1)),!0},loadPrevious:function(){var e=this.range.first-1,s=this.sanitizeIndex(e-this.options.itemsLoadedPerPage+1);this.range.setFirst(s);var n=s+2*this.options.itemsLoadedPerPage;return this.automaticDetection&&n<this.range.last&&n<=this.options.lastNode&&(this.range.setLast(n),this.loadPageTimeouts[n]&&(clearTimeout(Endless.loadPageTimeouts[n]),this.loadPageTimeouts[n]=null,this.pagesLoading--)),this.loadPage(s,e,!0)},loadNext:function(){var e=this.range.last+1,s=this.sanitizeIndex(e+this.options.itemsLoadedPerPage-1);this.range.setLast(s);var n=e-2*this.options.itemsLoadedPerPage;return this.automaticDetection&&n>this.range.first&&n>=0&&(this.range.setFirst(n+this.options.itemsLoadedPerPage),this.loadPageTimeouts[n]&&(clearTimeout(this.loadPageTimeouts[n]),this.loadPageTimeouts[n]=null,this.pagesLoading--)),this.loadPage(e,s)},loadNearNumber:function(e){var s=Endless.sanitizeIndex(e-this.options.itemsLoadedPerPage/2),n=s+this.options.itemsLoadedPerPage;return this.range.reset(s,n),this.paused=!0,this.redraw().then(()=>{this.ajax.requestRange(s,n).then(()=>{this.scrollHandler.toNumber(e).done(()=>{Endless.unpause()})})})},loadPage:function(s,n,t){var r=$.Deferred();if(s<Endless.range.first||n>Endless.range.last||s>n)return r.resolve().promise();var o=t?'[data-node-number="'+Endless.range.last+'"]':'[data-node-number="'+Endless.range.first+'"]';Endless.anchorScroll(o,()=>Endless.redraw()),e.trigger("endless:afterPlaceholdersLoad"),Endless.loadPageTimeouts[s]=setTimeout(()=>{$.when(Endless.ajax.requestRange(s,n,t)).then(()=>{Endless.pagesLoading--}),Endless.loadPageTimeouts[s]=null},Endless.pagesLoading?1e3:0),Endless.pagesLoading++},sanitizeIndex:function(e){return Math.max(1,Math.min(Endless.options.lastNode,e))},getMarginTop:function(){return Endless.marginTop=Endless.marginTop?Endless.marginTop:$("#header").outerHeight(!0),Endless.marginTop},calculateVisibleItems:function(){var e=Endless.getMarginTop(),s=Endless.scrollListener.currentTop+e,n=$(window).height()-e,t=0,r=0,o=0,a=0,l=0;o=0;if($("[data-node-number]").each(function(){var e=$(this),i=e.offset().top,d=e.outerHeight(!0);if(i+d<s)return!0;if(i+d>s&&(t||(t=r=e.attr("data-node-number")),i+d<s+n&&(r=e.attr("data-node-number")),i>s+n))return!1;var c=Math.max(0,s-i),u=Math.min(d,s+n-i)-c;(i<=s||0==l)&&(l=parseFloat(e.attr("data-node-number")-1)+c/d),u>0&&(o+=u/d),a=e.attr("data-time")}),Endless.scrubber.index=l,Endless.scrubber.visible=o,a){var i=new Date(1e3*parseInt(a));Endless.scrubber.description=Endless.lang.months[i.getMonth()]+" "+i.getUTCFullYear()}return Endless.visibleItems.first=parseInt(t),Endless.visibleItems.last=parseInt(r),Endless.visibleItems},range:{first:0,last:0,setFirst:function(e){return Endless.range.first=Number(e)},setLast:function(e){return Endless.range.last=Number(e)},countCurrentItems:function(){return Endless.itemsInDOM.length},countTotalItems:function(){return Endless.options.lastNode},calculateCurrent:function(){var e=Endless.itemsInDOM.slice();e.sort(function(e,s){return e-s}),Endless.range.setFirst(e.length?e[0]:1),Endless.range.setLast(e[e.length-1])},reset:function(e,s){return Endless.range.setFirst(e||1),Endless.range.setLast(Endless.sanitizeIndex(s||Endless.options.itemsLoadedPerPage)),Endless.range}},cache:{normalize:function(){return Endless.itemsInDOM.length=0,$("[data-node-number]").each((e,s)=>{Endless.itemsInDOM.push($(s).attr("data-node-number"))}),Endless.itemsInDOM.sort(function(e,s){return e-s}),Endless.range.calculateCurrent()}},scrubber:{index:0,visible:0,description:"",dragging:!1,mouseStart:0,indexStart:0,lastItem:0,show:function(){var e=$(Endless.templates.scrubber.replace(/\{totalItems\}/g,Endless.range.countTotalItems()));$(".PostStreamScrubber").length||$("body").append(e),Endless.scrubber.renderScrollbar()},onClick:function(e){try{var s=$(".Scrubber-scrollbar"),n=((e.clientY||e.originalEvent.touches[0].clientY)-s[0].getBoundingClientRect().top+$("body").scrollTop())/s.outerHeight(!0)*100,t=(n-=parseFloat(s.find(".Scrubber-handle")[0].style.height)/2)/Endless.scrubber.percentPerItem().index;t=Math.max(0,Math.min(Endless.range.countTotalItems()-1,t));var r=Endless.scrubber.visible,o=1==Math.min(t,Endless.range.countTotalItems()-r)?1:Math.ceil(t+r);Endless.loadNearNumber(o),Endless.scrubber.index=t,Endless.scrubber.renderScrollbar(!0),Endless.scrubber.closeDropdown()}catch(e){console.log(e)}},onResize:function(e){Endless.scrollListener.update(!0);var s=$(".PostStreamScrubber"),n=$(".Scrubber-scrollbar");n.css("max-height",$(window).height()-s.offset().top+$(window).scrollTop()-(s.outerHeight()-n.outerHeight())-30)},onMouseDown:function(e){Endless.paused=!0,Endless.scrubber.mouseStart=e.clientY||e.originalEvent.touches[0].clientY,Endless.scrubber.indexStart=Endless.scrubber.index,Endless.scrubber.dragging=!0,$("body").css("cursor","move")},onMouseMove:function(e){if(Endless.scrubber.dragging)try{var s=((e.clientY||e.originalEvent.touches[0].clientY)-Endless.scrubber.mouseStart)/$(".Scrubber-scrollbar").outerHeight()*100/Endless.scrubber.percentPerItem().index||0;Endless.scrubber.index=Endless.sanitizeIndex(Endless.scrubber.indexStart+s),Endless.scrubber.renderScrollbar()}catch(e){}},onMouseUp:function(e){if(Endless.scrubber.dragging){Endless.scrubber.mouseStart=0,Endless.scrubber.indexStart=0,Endless.scrubber.dragging=!1,$("body").css("cursor",""),Endless.scrubber.closeDropdown();var s=Endless.scrubber.index,n=Endless.scrubber.visible,t=1==Math.min(s,Endless.range.countTotalItems()-n)?1:Math.ceil(s+n);Endless.loadNearNumber(t),Endless.scrubber.renderScrollbar(!0)}},goToFirst:function(){Endless.loadNearNumber(0),Endless.scrubber.index=0,Endless.scrubber.renderScrollbar(!0),Endless.scrubber.closeDropdown()},goToLast:function(){Endless.loadNearNumber(Endless.range.countTotalItems()),Endless.scrubber.index=Endless.range.countTotalItems(),Endless.scrubber.renderScrollbar(!0),Endless.scrubber.closeDropdown()},toggleDropdown:function(){return $(".PostStreamScrubber").toggleClass("open")},closeDropdown:function(){return $(".PostStreamScrubber").removeClass("open")},renderScrollbar:function(e){if(Endless.options.automaticDetection&&Endless.options.enableScrubber){var s=$(".PostStreamScrubber");if(!s.length)return Endless.delayExecution("renderScrollbar",Endless.scrubber.renderScrollbar);var n=Endless.scrubber.percentPerItem(),t=Endless.scrubber.index,r=Endless.range.countTotalItems(),o=Endless.scrubber.visible||1,a=Math.min(t,r-o),l=1==a?1:Math.ceil(t+o);(l=Endless.sanitizeIndex(l))!=Endless.scrubber.lastItem&&(s.find(".Scrubber-index").text(l),s.find(".Scrubber-description").text(Endless.scrubber.description),s.toggleClass("disabled",Endless.scrubber.disabled()),Endless.scrubber.lastItem=l);var i={};i.before=Math.max(0,n.index*a),i.before==n.index&&(i.before=0),i.handle=Math.min(100-i.before,n.visible*o),i.after=100-i.before-i.handle;var d=e?"animate":"css";for(var c in i){var u=s.find(".Scrubber-"+c).stop(!0,!0)[d]({height:i[c]+"%"},"fast");"animate"===d&&u.css("overflow","visible")}return l}},disabled:function(){return Endless.scrubber.visible>=Endless.range.countTotalItems()},percentPerItem:function(){var e=Endless.range.countTotalItems()||1,s=Endless.scrubber.visible||1,n=50/$(".Scrubber-scrollbar").outerHeight()*100,t=Math.max(100/e,n/s);return{index:e===s?0:(100-t*s)/(e-s),visible:t}}},scrollHandler:{toNumber:function(e,s,n){e=Endless.sanitizeIndex(e);var t=$('[data-node-number="'+parseInt(e)+'"]');return Endless.scrollHandler.toItem(t,s,!0)},toItem:function(e,s,n){var t=$("html, body").stop(!0);if(e.length){var r=$(window).height(),o=e.offset(),a=o.top-Endless.getMarginTop(),l=o.top+e.outerHeight(),i=$(document).scrollTop();if(n||a<i||l>i+r){var d=l-r;l-a>r&&(d=a),s?t.scrollTop(d):d!==i&&t.animate({scrollTop:d},"fast")}e.addClass(Endless.class.scrolledItem),Endless.delayExecution("removeScrolledItemClass",()=>{$("[data-node-number]").removeClass(Endless.class.scrolledItem)},1200)}return t.promise()}},scrollListener:{requestAnimationFrame:window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame,active:!1,lastTop:-1,currentTop:-1,setCallback:function(e){Endless.scrollListener.callback=e},loop:function(){if(!Endless.scrollListener.active)return!1;Endless.scrollListener.update(),Endless.scrollListener.requestAnimationFrame.call(window,Endless.scrollListener.loop)},update:function(e){Endless.scrollListener.currentTop=window.pageYOffset,(Endless.scrollListener.lastTop!==Endless.scrollListener.currentTop||e)&&(Endless.scrollListener.callback(Endless.scrollListener.currentTop),Endless.scrollListener.lastTop=Endless.scrollListener.currentTop)},start:function(e){Endless.scrollListener.active||(Endless.scrollListener.setCallback(e),Endless.scrollListener.active=!0,Endless.scrollListener.lastTop=-1,Endless.scrollListener.loop())},stop:function(){Endless.scrollListener.active=!1}},unpause:function(){Endless.paused=!1,Endless.scrollListener.update(!0),Endless.scrubber.renderScrollbar(!0)},ajax:{request:function(e){return e.infinite=1,e.cid=Endless.options.cid,e.action=Endless.mode,Endless.options.custom&&(e.custom=Endless.options.custom),$.ajax({type:"GET",url:"xmlhttp.php",data:e})},requestRange:function(s,n,t){var r=$.Deferred();Endless.loadIds.length=0,s=Endless.sanitizeIndex(s),n=Endless.sanitizeIndex(n);for(var o=s;o<=n;o++)Endless.exists(Endless.itemsCache[o])||Endless.loadIds.push(o);return Endless.loadIds.length?$.when(Endless.ajax.request({range:Endless.loadIds.join()})).then(function(s,o,a){var l=$.parseJSON(a.responseText),i=t?'[data-node-number="'+Endless.range.last+'"]':'[data-node-number="'+Endless.range.first+'"]';return Endless.anchorScroll(i,()=>{var s=0;"object"==typeof l&&$.each(l,function(e,n){Endless.saveItemInCache(e,$("<div />").append(n.content).find(".post:first, .thread:first").attr("data-node-number",e).end().contents(),n.id),s=e}),e.trigger("endless:afterPageLoad"),Endless.redraw();var r=$(".endless-placeholder");s<n&&r.length&&($.each(r,function(e,s){return Endless.removeFromTree($(this).attr("data-node-number")),$(this).remove()}),Endless.options.lastNode=Number(s),Endless.range.calculateCurrent(),t?$(".loadPrevPage").remove():$(".loadNextPage").remove())}),r.resolve().promise()}):r.resolve().promise()}},anchorScroll:function(e,s){$(e).length||(e="[data-node-number]:first");var n=$(window),t=$(e).offset().top-n.scrollTop();return s(),$(e).length||(e="[data-node-number]:first"),n.scrollTop($(e).offset().top-t)},getClosestIdentifier:function(e,s){var n;(s=s.slice()).sort(function(e,s){return e-s});for(var t=0,r=s.length-1;r-t>1;)s[n=Math.floor((t+r)/2)]<e?t=n:r=n;return e-s[t]<=s[r]-e?Number(s[t]):Number(s[r])},generateRandomInteger:function(e,s){return Math.floor(Math.random()*(s-e+1))+e},exists:function(e){return!(void 0===e||null==e||!e)},delayExecution:function(e,s,n){n||(n=200);try{clearTimeout(Endless.timeouts[e]),Endless.timeouts[e]=setTimeout(()=>{s()},n)}catch(e){}}}}();